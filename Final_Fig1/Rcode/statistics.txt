#assumption:0h.internalpAremoved.1million.bed .... all temproal bed files with pA removed, and normalized to 1million is correct files.

Step0:
In R,
Code Name:
Step0_Normalize Readcount to 1million.Rmd

Output:
cps.0h.withoutinternalpA.1million.bed
cps.1h.withoutinternalpA.1million.bed
cps.2h.withoutinternalpA.1million.bed
cps.4h.withoutinternalpA.1million.bed


Step1:
In Bash,
Code Name: 
step1_mergePASsinallsamplesandFilterwthgt5.sh

#build full length window, and filter out readcount less than 5.
#Final PASs with greater than 5 readcounts in each PAS window: n=47986

Output:
cps.all.full.window.internalpAremoved.gt5.bed


Step2:

In R,
Code Name:
UTR1kbextension.Rmd

#UTR last exon 1kb extension
#Extract 3UTR regions in bed12
#Split the blocks into bed6 format.

Output:



Step3: CPS mapping in UTR+1kb

In Bash,
Code Name:
step3_PASmappingin3UTR1kb.sh

Input:
$1: 3UTR.1kb.extension.bed6
$2: cps.all.full.window.internalpAremoved.gt5.bed


#Mapping PAS in 3UTR+1kb region.

Output:
cpsin3UTR1kb.bed6
cpsin3UTR1kb.mn.bed7
cpsin3UTR1kb.pl.bed7



Step4: Statistics of all de novo CPS


#all De novo CPS (after internal priming removal, normalize to 1 million, and headcount cut off 5: n=47,986

#3'UTR 1kb region mapping: n=30,980
Coverage: hgnc=10589 genes



Output:
final.30980cps.in.3UTR.1kb.ext.txt

#Contain ratio of the PAS per hgnc.

Step5: Readcount table : At a given PAS, readcount per temporal sample.

In Bash,

#Using 
cps.0h.withoutinternalpA.1million.bed
cps.1h.withoutinternalpA.1million.bed
cps.2h.withoutinternalpA.1million.bed
cps.4h.withoutinternalpA.1million.bed
Calculate readcount at a given window.


CodeName: step5_readcountpertemporalsampleatCPS.sh
Input:
$1: cps.all.full.window.internalpAremoved.gt5.bed

Output:
cps.rc.0h.txt
cps.rc.1h.txt
cps.rc.2h.txt
cps.rc.4h.txt


Step6.ReadcountTable.

In R,

INPUT:
cps.rc.0h.txt
cps.rc.1h.txt
cps.rc.2h.txt
cps.rc.4h.txt

OUTPUT:
"all.cps.positions.readcount.txt"


Step9:

In bash
Code Name: step9_PASmappingAllregions.sh 
Command:
bash step9_PASmappingAllregions.sh ./Reference/transcripts.bed13 cps.all.full.window.internalpAremoved.gt5.bed 

#Intersect the de novo PASs in all regions+1kbextension not limited to 3UTR 1kb.


Output:cpsinallregions.bed



Step10. 

In R,
Code.Name: Fig1f.Rmd

Output:

"summaryoftallyof genes withCPScount.08.07.2020.txt"
Number of genes with different numbers of poly(A) sites_08.07.2020.pdf
